<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>5.3.2.3.2. Align method &#8212; MCAF R6 RC8 documentation (docver 6.0.2)</title>
    <link rel="stylesheet" href="../../_static/microchip.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mcaf_doc.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/svgcrop.js"></script>
    <script type="text/javascript" src="../../_static/mcaf-styling.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js"></script>
    <script type="text/javascript" src="../../_static/rendermath.js"></script>
    
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.3.2.3.3. Align-and-sweep method" href="align-sweep.html" />
    <link rel="prev" title="5.3.2.3.1. Implementation issues common to all methods" href="common.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="align-sweep.html" title="5.3.2.3.3. Align-and-sweep method"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="common.html" title="5.3.2.3.1. Implementation issues common to all methods"
             accesskey="P">previous</a> |</li>
    <li><img class="nav-logo"
             src="../../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../../index.html">MCAF R6 RC8 (docver 6.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="../index.html" >5. Detailed Algorithm Notes</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../estimators.html" >5.3. Position and Velocity Estimation</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../qei.html" accesskey="U">5.3.2. Quadrature encoder support</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <span class="target" id="qei-sync-align"></span><div class="section" id="align-method">
<span id="index-0"></span><h1>5.3.2.3.2. Align method<a class="headerlink" href="#align-method" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>5.3.2.3.2.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>In the absence of load torques (cogging, friction, disturbance),
if a fixed αβ-frame stator current vector is applied,
the motor will align along the d-axis, since this reaches a point
of equilibrium where the electromagnetic torque is zero.</p>
<p>The align method of back-EMF synchronization uses this method for a simple
and generally-reliable method of obtaining a commutation offset that is accurate
within a few electrical degrees for many motors.</p>
<p>There are, however, subtleties with this method, especially when
used with motors that have substantial cogging torque.</p>
<p>If there are load torques when using the align method,
the motor will reach a point of equilibrium
with an electrical-angle offset <span class="math">\(\tilde{\theta}\)</span>
from the d-axis such that <span class="math">\(T_{load} + \frac{3}{2}K_eI\sin\tilde{\theta} = 0\)</span>,
in other words, <span class="math">\(\tilde{\theta} = -\sin^{-1}\dfrac{T_{load}}{\frac{3}{2}K_eI}\)</span>.
Cogging/detent torque for low-cost motors may be in the range of 5-10% of continuous rated torque
plus 1-3% for friction, so if we use a current I equal to continuous rated current
we should expect on the order of <span class="math">\(\tilde{\theta} = \sin^{-1} 0.13 \approx 7.5^{\circ}\)</span>
worst-case error. Oversized motors, where the drive cannot deliver current
to achieve continuous rated torque, will have larger errors.
(example: if total load torque is 13% continuous rated torque,
and the drive can deliver 50% continuous rated torque, then we
should expect arcsin(13/50) ≈ 15.1° worst-case error.)</p>
<p>The <a class="reference internal" href="../startup.html#startup-sequence"><span class="std std-ref">startup sequence</span></a>’s “align” state
(where the current vector magnitude and angle are fixed) is utilized
to allow a suitable settling time to reach mechanical equilibrium, and
at the end of this time, the difference between
the applied commutation angle and the encoder count is computed
and used to obtain a commutation offset.</p>
</div>
<div class="section" id="limitations">
<span id="qei-sync-align-limitations"></span><h2>5.3.2.3.2.2. Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Continuous torque disturbances can prevent mechanical equilibrium</li>
<li>There is a semistable equilibrium point (locally stable, globally unstable) around
<span class="math">\(\tilde\theta = 180^\circ\)</span>
where the cogging torque pulls the rotor towards a particular detent position,
and the electromagnetic torque is small enough that it cannot pull the rotor
out of the detent unless a different commutation angle is applied.</li>
</ul>
</div>
<div class="section" id="practical-implementation-issues">
<h2>5.3.2.3.2.3. Practical implementation issues<a class="headerlink" href="#practical-implementation-issues" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">The angles used in the rampup and align states of startup sequence are important,
particularly the angle shift: a different commutation angle can be applied
during the rampup and align states, to improve the ability of the align method to overcome torque detents and keep
from getting stuck at a semistable equilibrium point.</p>
<p>A more in-depth discussion of angle shift is shown below in the
<a class="reference internal" href="#qei-sync-align-example-data"><span class="std std-ref">section containing example data</span></a>.</p>
</li>
<li><p class="first">MCAF applies current during the align phase along the q-axis, not the d-axis,
so the estimated commutation offset has a <span class="math">\(\pm 90^\circ\)</span> offset from
the angle difference between applied
commutation electrical angle and measured encoder electrical angle at the end
of the align phase. The sign of this <span class="math">\(\pm 90^\circ\)</span> offset
depends on the sign of the q-axis current used.
(Negative q-axis current is applied during startup when the motor is started
in the reverse direction.) In other words,
<span class="math">\(\hat\theta_{ofs} = (\theta_{enc} - \theta_{e}) + 90^\circ \operatorname{sgn} I_q\)</span> where
the angle subscripts <em>ofs</em>, <em>enc</em>, and <em>e</em> refer to commutation offset,
encoder angle (in electrical terms), and forced electrical angle, respectively.</p>
</li>
</ul>
</div>
<div class="section" id="example-data">
<span id="qei-sync-align-example-data"></span><h2>5.3.2.3.2.4. Example data<a class="headerlink" href="#example-data" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#fig-qei-align1"><span class="std std-numref">Figure 5.39</span></a> shows the use of the align method with the Anaheim Automation
BLWS232D-24V-1350-1024SI5, which has a 1024-line encoder and fairly low cogging torque.
For this motor, the align method works very well, with low error.
The yellow highlight shows the current rampup state (current not shown),
at an applied electrical angle <span class="math">\(\theta_0 = 0^\circ\)</span>, and the green highlight shows the align state,
at an applied electrical angle <span class="math">\(\theta_1 = 30^\circ\)</span>. The motor takes roughly 0.15 seconds to settle to
equilibrium, so the align time of 0.5s leaves plenty of time to reach an encoder angle of 120°,
which is 90° ahead of the applied electrical angle.</p>
<div class="figure align-center" id="id1">
<span id="fig-qei-align1"></span><img alt="../../_images/2118-in-action-blws232d.png" src="../../_images/2118-in-action-blws232d.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.39 </span><span class="caption-text">Align method with BLWS232D-24V-1350-1024SI5, <span class="math">\(\theta_0 = 0^\circ, \theta_1 = 30^\circ\)</span></span></p>
</div></div>
<p>The remaining graphs in this section show the use of the align method with the
Anaheim Automation BLY342D-48V-3200-1024SI5. This motor has substantial cogging torque,
and because of this, the success of the align method depends on initial conditions
and the choice of startup angles.
<a class="reference internal" href="#fig-qei-align2"><span class="std std-numref">Figure 5.40</span></a> shows
this motor during startup, with applied electrical angles of 0° during both rampup and align
states: <span class="math">\(\theta_0 = \theta_1 = 0^\circ\)</span>.
In this case, the initial angle of the motor <span class="math">\(\theta_{init}\)</span> was around 65° from equilibrium,
and the transient settles down quickly.</p>
<div class="figure align-center" id="id2">
<span id="fig-qei-align2"></span><img alt="../../_images/2118-in-action-bly342d-48v-3200-1.png" src="../../_images/2118-in-action-bly342d-48v-3200-1.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.40 </span><span class="caption-text">Align method with BLY342D-48V-3200-1024SI5, <span class="math">\(\theta_0 = \theta_1 = 0^\circ, \theta_{init}\approx 155^\circ\)</span></span></p>
</div></div>
<p>When the initial position of the rotor is roughly 180° from equilibrium, the rotor
can get stuck in a detent at semistable equilibrium. <a class="reference internal" href="#fig-qei-align3"><span class="std std-numref">Figure 5.41</span></a> shows
such a case, where the rotor
reaches the correct equilibrium eventually, but its transient is much longer.</p>
<div class="figure align-center" id="id3">
<span id="fig-qei-align3"></span><img alt="../../_images/2118-in-action-bly342d-48v-3200-3.png" src="../../_images/2118-in-action-bly342d-48v-3200-3.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.41 </span><span class="caption-text">Align method with BLY342D-48V-3200-1024SI5, <span class="math">\(\theta_0 = \theta_1 = 0^\circ, \theta_{init}\approx 275^\circ\)</span></span></p>
</div></div>
<p><a class="reference internal" href="#fig-qei-align4"><span class="std std-numref">Figure 5.42</span></a> shows almost the same starting angle, but this time it
remains stuck in a semistable equilibrium. Note that during the align phase, highlighted
green, the rotor angle does not move significantly, and remains approximately 270°
ahead of the applied electrical angle, whereas in successful uses of the align method,
it should reach equilibrium at 90° ahead of the applied electrical angle.
In this case, the calculated commutation offset would be off by 180°,
leading to backward instead of forward rotation.</p>
<div class="figure align-center" id="id4">
<span id="fig-qei-align4"></span><img alt="../../_images/2118-in-action-bly342d-48v-3200-2.png" src="../../_images/2118-in-action-bly342d-48v-3200-2.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.42 </span><span class="caption-text">Align method with BLY342D-48V-3200-1024SI5, <span class="math">\(\theta_0 = \theta_1 = 0^\circ, \theta_{init}\approx 275^\circ\)</span>,
This shows the case where the rotor is stuck in semistable equilibrium near its initial conditions.</span></p>
</div></div>
<p>The use of an angle shift can prevent this situation.</p>
<p><a class="reference internal" href="#fig-qei-align5"><span class="std std-numref">Figure 5.43</span></a> shows similar initial conditions but with the applied angle during
the align phase shifted by 30°. Here the rampup phase remains stuck in semistable
equilibrium, but the align phase is able to escape the detent and reach its intended
position.</p>
<div class="figure align-center" id="id5">
<span id="fig-qei-align5"></span><img alt="../../_images/2118-in-action-bly342d-48v-3200-4.png" src="../../_images/2118-in-action-bly342d-48v-3200-4.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.43 </span><span class="caption-text">Align method with BLY342D-48V-3200-1024SI5, <span class="math">\(\theta_0 = 0^\circ, \theta_1 = 30^\circ, \theta_{init}\approx 275^\circ\)</span>.</span></p>
</div></div>
<p><a class="reference internal" href="#fig-qei-align5"><span class="std std-numref">Figure 5.43</span></a> shows similar initial conditions, with the applied angle during
the align phase at 0° but at 330° during the rampup phase. In this case,
the rampup phase provides enough torque to give the motor a kick and prevent it from
getting stuck in equilibrium.</p>
<div class="figure align-center" id="id6">
<span id="fig-qei-align6"></span><img alt="../../_images/2118-in-action-bly342d-48v-3200-5.png" src="../../_images/2118-in-action-bly342d-48v-3200-5.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.44 </span><span class="caption-text">Align method with BLY342D-48V-3200-1024SI5, <span class="math">\(\theta_0 = 330^\circ, \theta_1 = 0^\circ, \theta_{init}\approx 275^\circ\)</span>.</span></p>
</div></div>
<p>This technique of adding an angle shift is not foolproof, but it does seem to be reasonably
robust. Tests of several motors with high cogging torque were able to align successfully
with an angle shift in the 30° - 60° range.</p>
</div>
<div class="section" id="accuracy-and-repeatability-tests">
<h2>5.3.2.3.2.5. Accuracy and repeatability tests<a class="headerlink" href="#accuracy-and-repeatability-tests" title="Permalink to this headline">¶</a></h2>
<p>The align method was tested with MCAF R4, and the resulting commutation offset from index
(<code class="docutils literal notranslate"><span class="pre">motor.estimator.qei.position.commutationOffsetFromIndex</span></code>) was compared against a reference
method using open-circuit voltage measurements of the motor terminals with the motor
rotated mechanically at constant speed.</p>
<p><a class="reference internal" href="#table-qei-sync-align-accuracy"><span class="std std-numref">Table 5.2</span></a> describes the results.
In each case, 64 iterations of the align method were performed,
with initial conditions at evenly-spaced angles spanning one electrical cycle.
Except where noted, the settings for the align method are the default values of
<span class="math">\(\theta_0 = 330^\circ\)</span> during the rampup state and
<span class="math">\(\theta_1 = 0^\circ\)</span> during the align state (angle shift of 30°).
Each motor was used with a dsPICDEM<sup>®</sup> MCLV‑2 Development Board, with default current limit of 2.29A, and default
startup current at 91% of the current limit = 2.08A.</p>
<table border="1" class="docutils" id="table-qei-sync-align-accuracy">
<caption><span class="caption-number">Table 5.2 </span><span class="caption-text">Accuracy and repeatability metrics for the align method</span><a class="headerlink" href="#table-qei-sync-align-accuracy" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="37%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">mean <span class="math">\(\tilde\theta_{ofs}\)</span></th>
<th class="head">max <span class="math">\(\tilde\theta_{ofs}\)</span></th>
<th class="head">stdev <span class="math">\(\hat\theta_{ofs}\)</span></th>
<th class="head">span <span class="math">\(\hat\theta_{ofs}\)</span></th>
<th class="head">Test case</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0.39°</td>
<td>0.43°</td>
<td>0.07°</td>
<td>0.18°</td>
<td>BLWS232D-24V-1350-1024SI5</td>
</tr>
<tr class="row-odd"><td>1.00°</td>
<td>1.50°</td>
<td>0.28°</td>
<td>0.97°</td>
<td>BLY171D-24V-4000 with 4096-line encoder</td>
</tr>
<tr class="row-even"><td>15.44°</td>
<td>189.35°</td>
<td>54.47°</td>
<td>352.62°</td>
<td>BLY342D-24V-3000-1024SI5, 30° angle shift</td>
</tr>
<tr class="row-odd"><td>3.68°</td>
<td>4.43°</td>
<td>0.44°</td>
<td>2.46°</td>
<td>BLY342D-24V-3000-1024SI5, 60° angle shift</td>
</tr>
<tr class="row-even"><td>3.44°</td>
<td>3.91°</td>
<td>0.42°</td>
<td>1.41°</td>
<td>BLY342D-48V-3200-1024SI5</td>
</tr>
</tbody>
</table>
<p>The error metrics are as follows:</p>
<ul class="simple">
<li>mean <span class="math">\(\tilde\theta_{ofs}\)</span> — mean value of the commutation offset difference between the align method and the reference method</li>
<li>max <span class="math">\(\tilde\theta_{ofs}\)</span> — maximum value of the commutation offset difference between the align method and the reference method</li>
<li>stdev <span class="math">\(\hat\theta_{ofs}\)</span> — standard deviation of commutation offset estimated by the align method</li>
<li>span <span class="math">\(\hat\theta_{ofs}\)</span> — difference between minimum and maximum commutation offset estimated by the align method</li>
</ul>
<p>The BLY342D-24V-3000-1024SI5 required a larger angle shift (60°) to work reliably. With the default value of
30°, initial conditions near 180° from equilibrium cause the motor to get stuck in semistable
equilibrium. This is more severe with the BLY342D-24V-3000 than the BLY342D-48V-3200; both motors
use the same lamination stack and rotor but are wound differently, with the BLY342D-24V-3000 having
higher rated current and a lower value of <span class="math">\(K_e\)</span>,
so that the 2.08A is not able to exert as much torque during the align phase.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.3.2.3.2. Align method</a><ul>
<li><a class="reference internal" href="#overview">5.3.2.3.2.1. Overview</a></li>
<li><a class="reference internal" href="#limitations">5.3.2.3.2.2. Limitations</a></li>
<li><a class="reference internal" href="#practical-implementation-issues">5.3.2.3.2.3. Practical implementation issues</a></li>
<li><a class="reference internal" href="#example-data">5.3.2.3.2.4. Example data</a></li>
<li><a class="reference internal" href="#accuracy-and-repeatability-tests">5.3.2.3.2.5. Accuracy and repeatability tests</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="common.html"
                        title="previous chapter">5.3.2.3.1. Implementation issues common to all methods</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="align-sweep.html"
                        title="next chapter">5.3.2.3.3. Align-and-sweep method</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="align-sweep.html" title="5.3.2.3.3. Align-and-sweep method"
             >next</a> |</li>
        <li class="right" >
          <a href="common.html" title="5.3.2.3.1. Implementation issues common to all methods"
             >previous</a> |</li>
    <li><img class="nav-logo"
             src="../../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../../index.html">MCAF R6 RC8 (docver 6.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="../index.html" >5. Detailed Algorithm Notes</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../estimators.html" >5.3. Position and Velocity Estimation</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../qei.html" >5.3.2. Quadrature encoder support</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-2020, Microchip Technology, Inc..
    </div>
  </body>
</html>