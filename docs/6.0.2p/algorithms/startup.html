<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>5.2. Startup &#8212; MCAF R6 RC8 documentation (docver 6.0.2)</title>
    <link rel="stylesheet" href="../_static/microchip.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/mcaf_doc.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/svgcrop.js"></script>
    <script type="text/javascript" src="../_static/mcaf-styling.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js"></script>
    <script type="text/javascript" src="../_static/rendermath.js"></script>
    
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.3. Position and Velocity Estimation" href="estimators.html" />
    <link rel="prev" title="5.1.4. Current loop tuning" href="foc/tuning.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="estimators.html" title="5.3. Position and Velocity Estimation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="foc/tuning.html" title="5.1.4. Current loop tuning"
             accesskey="P">previous</a> |</li>
    <li><img class="nav-logo"
             src="../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../index.html">MCAF R6 RC8 (docver 6.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">5. Detailed Algorithm Notes</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="startup">
<span id="algorithm-startup"></span><span id="index-0"></span><h1>5.2. Startup<a class="headerlink" href="#startup" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>5.2.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>MCAF includes two different startup methods. Both methods are compatible with sensorless estimators
that have a minimum operating speed. Each will operate in closed-loop current control with a forced
commutation angle, to bring the motor from a stop to a transition speed where the motor can switch
to closed-loop commutation. The only difference between the two methods is how they handle this transition.</p>
<div class="section" id="method-1-classic-current-decay">
<h3>5.2.1.1. Method 1: Classic (current decay)<a class="headerlink" href="#method-1-classic-current-decay" title="Permalink to this headline">¶</a></h3>
<p>The classic method was originally introduced in MCAF R1, and has been the only available method
until MCAF R4. This method transitions by decreasing
commanded current until the sensorless estimator’s angle estimate approaches the forced commutation angle, or
until the current has dropped below a threshold. This works by allowing the true d-axis current to decrease;
as discussed further in the section on <a class="reference internal" href="#startup-phasor-analysis"><span class="std std-ref">phasor analysis</span></a>.</p>
</div>
<div class="section" id="method-2-weathervane-reference-frame-alignment">
<h3>5.2.1.2. Method 2: Weathervane (reference frame alignment)<a class="headerlink" href="#method-2-weathervane-reference-frame-alignment" title="Permalink to this headline">¶</a></h3>
<p>The “Weathervane” method was introduced in MCAF R4. This method transitions by simultaneously rotating both the current
vector and the reference frame angle, until the sensorless estimator’s angle estimate approaches the forced
commutation angle.</p>
</div>
<div class="section" id="choice-of-startup-method">
<span id="startup-which-method"></span><h3>5.2.1.3. Choice of startup method<a class="headerlink" href="#choice-of-startup-method" title="Permalink to this headline">¶</a></h3>
<p>Startup method can be chosen in the Customize page of motorBench<sup>®</sup> Development Suite. Weathervane provides a faster startup,
and is more robust to disturbance torques than the classic method, but it may cause larger torque transients
during the transition.</p>
</div>
</div>
<div class="section" id="startup-sequence-and-common-elements">
<span id="startup-sequence"></span><h2>5.2.2. Startup sequence and common elements<a class="headerlink" href="#startup-sequence-and-common-elements" title="Permalink to this headline">¶</a></h2>
<p>Both methods proceed through the following sequence of startup states, and require the motor to be at rest
when commencing startup. For most of the startup sequence, velocity control is disabled and
closed-loop current control using FOC is enabled, but with a forced commutation angle.</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="18%" />
<col width="25%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Startup state</th>
<th class="head">Current</th>
<th class="head">Commutation</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Current rampup (<code class="docutils literal notranslate"><span class="pre">RAMPUP</span></code>)</td>
<td>Linear increase from
zero to
<code class="docutils literal notranslate"><span class="pre">MCAF_STARTUP_CURRENT</span></code></td>
<td>Fixed,
<code class="docutils literal notranslate"><span class="pre">STARTUP_RAMPUP_ANGLE</span></code></td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Align (<code class="docutils literal notranslate"><span class="pre">ALIGN</span></code>)</td>
<td>Fixed,
<code class="docutils literal notranslate"><span class="pre">MCAF_STARTUP_CURRENT</span></code></td>
<td>Fixed,
<code class="docutils literal notranslate"><span class="pre">STARTUP_RAMPUP_ANGLE</span></code> +
<code class="docutils literal notranslate"><span class="pre">STARTUP_ALIGN_ANGLE_DELTA</span></code></td>
<td><a class="reference internal" href="qei.html#qei-sync"><span class="std std-ref">QEI back-emf synchronization</span></a> can
keep startup in this state, and
can modify current or commutation angle.</td>
</tr>
<tr class="row-even"><td>Slow acceleration (<code class="docutils literal notranslate"><span class="pre">ACCEL0</span></code>)</td>
<td>Fixed,
<code class="docutils literal notranslate"><span class="pre">MCAF_STARTUP_CURRENT</span></code></td>
<td>Quadratic (linear velocity ramp)
with constant acceleration
<code class="docutils literal notranslate"><span class="pre">STARTUP_ACCELERATION0</span></code></td>
<td>Active damping allowed. Cogging torque
may be the dominant mechanical load.
Proceeds when
<code class="docutils literal notranslate"><span class="pre">STARTUP_ACCEL0_VELOCITY_THRESHOLD</span></code>
reached. (See <span class="math">\(\omega_0\)</span> in
<a class="reference internal" href="#fig-startup-sequence"><span class="std std-numref">Figure 5.32</span></a>.)</td>
</tr>
<tr class="row-odd"><td>Fast acceleration (<code class="docutils literal notranslate"><span class="pre">ACCEL1</span></code>)</td>
<td>Fixed,
<code class="docutils literal notranslate"><span class="pre">MCAF_STARTUP_CURRENT</span></code></td>
<td>Quadratic (linear velocity ramp)
with constant acceleration
<code class="docutils literal notranslate"><span class="pre">STARTUP_ACCELERATION1</span></code></td>
<td>Active damping allowed. Cogging torque
may be the dominant mechanical load.
Proceeds when
<code class="docutils literal notranslate"><span class="pre">STARTUP_ACCEL1_VELOCITY_THRESHOLD</span></code>
reached. (See <span class="math">\(\omega_1\)</span> in
<a class="reference internal" href="#fig-startup-sequence"><span class="std std-numref">Figure 5.32</span></a>.)</td>
</tr>
<tr class="row-even"><td>Spin (<code class="docutils literal notranslate"><span class="pre">HOLD</span></code>)</td>
<td>Fixed,
<code class="docutils literal notranslate"><span class="pre">MCAF_STARTUP_CURRENT</span></code></td>
<td>Linear
with constant velocity</td>
<td>Active damping allowed.
Can be held in this state for <a class="reference internal" href="qei.html#qei-sync"><span class="std std-ref">QEI back-emf synchronization</span></a></td>
</tr>
<tr class="row-odd"><td>Current rampdown
(<code class="docutils literal notranslate"><span class="pre">CURRENT_RAMPDOWN</span></code>) —
<strong>classic method only</strong></td>
<td>Exponential decay</td>
<td>Linear with constant velocity</td>
<td>Proceeds when angle deviation drops
below a threshold, or current drops
below a threshold.</td>
</tr>
<tr class="row-even"><td>Transition (<code class="docutils literal notranslate"><span class="pre">TRANSITION</span></code>) —
<strong>classic method only</strong></td>
<td>Output of velocity
controller</td>
<td>Output of estimator plus small
offset</td>
<td>Velocity controller enabled.
Commutation angle from estimator.
Offset angle chosen to create smooth
transition from previous state.
Startup complete when this reaches zero.</td>
</tr>
<tr class="row-odd"><td>Reference frame alignment
(<code class="docutils literal notranslate"><span class="pre">REF_FRAME_ALIGN</span></code>) —
<strong>weathervane method only</strong></td>
<td>Fixed,
<code class="docutils literal notranslate"><span class="pre">MCAF_STARTUP_CURRENT</span></code></td>
<td>Linear with constant velocity</td>
<td>Current vector rotated toward d-axis
to reflect its actual value.
Startup complete when angle deviation
drops below a threshold.</td>
</tr>
</tbody>
</table>
<p>This sequence can also be seen in <a class="reference internal" href="#fig-startup-sequence"><span class="std std-numref">Figure 5.32</span></a>:</p>
<div class="figure align-center" id="id2">
<span id="fig-startup-sequence"></span><img alt="../_images/startup-sequence.png" src="../_images/startup-sequence.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.32 </span><span class="caption-text">Graph of current and electrical frequency in startup sequence.
(The Weathervane startup algorithm is shown.)</span></p>
</div></div>
<p>MCAF R4 and R5 added the ability to adjust various startup
parameters in the Customize page of motorBench<sup>®</sup> Development Suite. See <a class="reference internal" href="../implementation/ui-customization.html#impl-customization"><span class="std std-ref">Parameter customization</span></a>
for more information.</p>
<div class="section" id="startup-status-codes">
<span id="id1"></span><h3>5.2.2.1. Startup status codes<a class="headerlink" href="#startup-status-codes" title="Permalink to this headline">¶</a></h3>
<p>To facilitate different startup algorithms which may not share the exact same sequence of states,
a common set of status codes has been created. The status code can be read using <code class="docutils literal notranslate"><span class="pre">MCAF_StartupGetStatus()</span></code>
and will be one of the following:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">MSST_ALIGN</span></code> — in an “alignment” phase
where the motor is being held at constant or slowly-changing electrical angle.
The state machine can be held in this state by other algorithms,
for example <a class="reference internal" href="qei.html#qei-sync"><span class="std std-ref">back-emf synchronization</span></a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">MSST_ACCEL</span></code> — in an “acceleration” phase where the motor is being accelerated.</li>
<li><code class="docutils literal notranslate"><span class="pre">MSST_SPIN</span></code> — in a “spin” phase where the electrical angle is being updated at constant frequency.
The state machine can be held in this state by other algorithms.</li>
<li><code class="docutils literal notranslate"><span class="pre">MSST_COMPLETE</span></code> — startup complete.</li>
<li><code class="docutils literal notranslate"><span class="pre">MSST_UNSPECIFIED</span></code> — startup in another state besides the above.</li>
</ul>
</div>
<div class="section" id="phasor-analysis">
<span id="startup-phasor-analysis"></span><h3>5.2.2.2. Phasor analysis<a class="headerlink" href="#phasor-analysis" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#fig-startup-phasor"><span class="std std-numref">Figure 5.33</span></a> shows a typical current vector during open-loop commutation. The magnitude of current <span class="math">\(I\)</span>
is chosen to be significantly higher than the required torque-producing current <span class="math">\(I_q\)</span>, so that the rotor is dragged along
and synchronization is maintained. (With this behavior, a PMSM behaves roughly like a stepper motor under microstepping operation.)
As a result, most of the current vector is along the d-axis. In MCAF, for the majority of startup, current is applied along the
q-axis of the open-loop reference frame, with no d-axis component, and therefore the open-loop reference frame’s q-axis is aligned
with the current vector. This means that the angle difference <span class="math">\(\varphi\)</span>
between the actual q-axis and the q-axis in software, is typically in the 60 - 90° range when the mechanical torque load
on the motor is relatively low.</p>
<p>The two methods work differently to create a relatively smooth transition to closed-loop operation:</p>
<ul class="simple">
<li>in the classic method, the magnitude of current is reduced. This has the effect of reducing d-axis current
while <span class="math">\(I_q\)</span> will remain roughly what is needed to counteract any mechanical torque loads.</li>
<li>in the weathervane method, the current vector is rotated so that the open-loop reference frame and actual rotor reference frames converge,
with most of the applied current along the d-axis and a small portion of it along the q-axis.</li>
</ul>
<div class="figure align-center" id="id3">
<span id="fig-startup-phasor"></span><img alt="../_images/startup-Idq.png" src="../_images/startup-Idq.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.33 </span><span class="caption-text"><strong>Current vector during forced commutation</strong> — most of the current is along the d-axis.</span></p>
</div></div>
<p>To illustrate this more clearly, the Hurst DMB0224C10002 (<a class="reference external" href="https://www.microchip.com/DevelopmentTools/ProductDetails/PartNO/AC300020">Microchip #AC300020</a>)
was used with an inertia load. Selected program variables were recorded during startup of both methods, with the AN1292 PLL as the estimator.</p>
</div>
</div>
<div class="section" id="classic-startup-current-decay">
<span id="startup-classic"></span><h2>5.2.3. Classic startup (current decay)<a class="headerlink" href="#classic-startup-current-decay" title="Permalink to this headline">¶</a></h2>
<p>In the classic method, current is decreased, as shown in <a class="reference internal" href="#fig-startup-classic"><span class="std std-numref">Figure 5.34</span></a>.
This causes the forced commutation angle to converge towards the angle derived from the estimator,
although sometimes this process is slow and requires a very small current.</p>
<div class="figure align-center" id="id4">
<span id="fig-startup-classic"></span><img alt="../_images/startup-hurst075J1-classic.png" src="../_images/startup-hurst075J1-classic.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.34 </span><span class="caption-text"><strong>Classic startup</strong></span></p>
</div></div>
<p>The different startup states are highlighted:</p>
<ul class="simple">
<li>Current rampup (1): red</li>
<li>Slow acceleration (3): yellow</li>
<li>Fast acceleration (4): green</li>
<li>Current rampdown (6): purple</li>
<li>Transition (7): gray</li>
</ul>
<p>(Note that the align (2) and spin (5) states are skipped in this example; these states allow
<a class="reference internal" href="qei.html#qei-sync"><span class="std std-ref">QEI back-emf synchronization</span></a> to occur, but
if there is no quadrature encoder or the synchronization has already occurred, then the startup sequence proceeds immediately
to the next state.)</p>
</div>
<div class="section" id="weathervane-startup">
<span id="startup-weathervane"></span><span id="index-1"></span><h2>5.2.4. Weathervane startup<a class="headerlink" href="#weathervane-startup" title="Permalink to this headline">¶</a></h2>
<p>In the weathervane method, the current vector is rotated, as shown in <a class="reference internal" href="#fig-startup-weathervane"><span class="std std-numref">Figure 5.35</span></a>.</p>
<p>This method has identical states as in the classic method, except that the reference frame align (state 6, highlighted purple)
replaces current rampdown, and there is no transition state at the end of startup.</p>
<p>The reference frame alignment can occur much faster than current rampdown, and does not seem to be affected by
the mechanical load of the motor.</p>
<div class="figure align-center" id="id5">
<span id="fig-startup-weathervane"></span><img alt="../_images/startup-hurst075J1-weathervane.png" src="../_images/startup-hurst075J1-weathervane.png" />
<div class="caption_wrapper"><p class="caption"><span class="caption-number">Figure 5.35 </span><span class="caption-text"><strong>Weathervane startup</strong></span></p>
</div></div>
</div>
<div class="section" id="active-damping">
<span id="index-2"></span><h2>5.2.5. Active damping<a class="headerlink" href="#active-damping" title="Permalink to this headline">¶</a></h2>
<p>When a PMSM is driven with constant current at a forced commutation angle at constant frequency,
its dynamics are roughly a very lightly-damped second-order system. There is a virtual “spring”
with restoring torque caused by any misalignment between the rotor magnetic field and the applied
stator field. This acts with the rotor inertia to oscillate. These oscillations can grow
when the motor is driven at an accelerating frequency, or if the current controller’s error
causes sufficient phase lag.</p>
<p>To help control this effect during forced commutation, MCAF contains an “active damping” feature.
This modulates the current during forced commutation, by applying a change in current that
is proportional to the difference in speed between the commutation frequency and the velocity obtained by
the estimator. Active damping is enabled only above a velocity threshold, since for many sensorless
estimators it is not possible to obtain accurate estimates at low velocities. (The velocity threshold
to enable active damping can be adjusted in the Customize page of motorBench<sup>®</sup> Development Suite.) This can be seen in <a class="reference internal" href="#fig-startup-classic"><span class="std std-numref">Figure 5.34</span></a>
and <a class="reference internal" href="#fig-startup-weathervane"><span class="std std-numref">Figure 5.35</span></a> during the fast acceleration state (highlighted green).</p>
</div>
<div class="section" id="slow-and-fast-acceleration">
<h2>5.2.6. Slow and fast acceleration<a class="headerlink" href="#slow-and-fast-acceleration" title="Permalink to this headline">¶</a></h2>
<p>The acceleration rate during startup is increased once the velocity reaches a certain threshold.
At low speeds, acceleration is lower to avoid cycle slips that can be caused by cogging torque.
At higher speeds, the cogging torque occurs at a higher frequency, and this torque ripple has
less of an effect on rotor dynamics, so that cycle slips are less likely to occur, and it’s possible
to increase velocity more quickly.
(Most of cogging torque ripple is absorbed by the rotor and load inertia.)</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.2. Startup</a><ul>
<li><a class="reference internal" href="#overview">5.2.1. Overview</a><ul>
<li><a class="reference internal" href="#method-1-classic-current-decay">5.2.1.1. Method 1: Classic (current decay)</a></li>
<li><a class="reference internal" href="#method-2-weathervane-reference-frame-alignment">5.2.1.2. Method 2: Weathervane (reference frame alignment)</a></li>
<li><a class="reference internal" href="#choice-of-startup-method">5.2.1.3. Choice of startup method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#startup-sequence-and-common-elements">5.2.2. Startup sequence and common elements</a><ul>
<li><a class="reference internal" href="#startup-status-codes">5.2.2.1. Startup status codes</a></li>
<li><a class="reference internal" href="#phasor-analysis">5.2.2.2. Phasor analysis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#classic-startup-current-decay">5.2.3. Classic startup (current decay)</a></li>
<li><a class="reference internal" href="#weathervane-startup">5.2.4. Weathervane startup</a></li>
<li><a class="reference internal" href="#active-damping">5.2.5. Active damping</a></li>
<li><a class="reference internal" href="#slow-and-fast-acceleration">5.2.6. Slow and fast acceleration</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="foc/tuning.html"
                        title="previous chapter">5.1.4. Current loop tuning</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="estimators.html"
                        title="next chapter">5.3. Position and Velocity Estimation</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="estimators.html" title="5.3. Position and Velocity Estimation"
             >next</a> |</li>
        <li class="right" >
          <a href="foc/tuning.html" title="5.1.4. Current loop tuning"
             >previous</a> |</li>
    <li><img class="nav-logo"
             src="../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../index.html">MCAF R6 RC8 (docver 6.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="index.html" >5. Detailed Algorithm Notes</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-2020, Microchip Technology, Inc..
    </div>
  </body>
</html>