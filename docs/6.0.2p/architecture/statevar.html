<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>3.3. State management &#8212; MCAF R6 RC8 documentation (docver 6.0.2)</title>
    <link rel="stylesheet" href="../_static/microchip.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/mcaf_doc.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/svgcrop.js"></script>
    <script type="text/javascript" src="../_static/preliminary-draft.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js"></script>
    <script type="text/javascript" src="../_static/rendermath.js"></script>
    
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.4. Code Generation" href="codegen.html" />
    <link rel="prev" title="3.2. Naming Conventions" href="naming.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="codegen.html" title="3.4. Code Generation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="naming.html" title="3.2. Naming Conventions"
             accesskey="P">previous</a> |</li>
    <li><img class="nav-logo"
             src="../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../index.html">MCAF R6 RC8 (docver 6.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">3. Architecture</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <span class="target" id="statevar"></span><div class="section" id="state-management">
<span id="index-0"></span><h1>3.3. State management<a class="headerlink" href="#state-management" title="Permalink to this headline">¶</a></h1>
<p>Motor control algorithms require maintenance of numerous state variables, for
things like control loops and estimators (integrator and filter state), state
machines (the state of the state machine), schedulers (countdown timers),
configuration parameters, and so on.</p>
<p>The motor control application framework defines several data structures for managing this
state data. The two top-level data structures are <code class="docutils literal notranslate"><span class="pre">MCAF_SYSTEM_DATA</span></code> and
<code class="docutils literal notranslate"><span class="pre">MCAF_MOTOR_DATA</span></code>, used for storing per-system and per-motor state variables,
respectively.</p>
<p>We used an approach consisting of three major aspects:</p>
<ul class="simple" id="index-1">
<li><strong>Structure</strong> — how are state variables organized?<ul>
<li>Group data in appropriate C structures</li>
<li>Follow the Goldilocks principle: not too big or too small</li>
</ul>
</li>
</ul>
<ul class="simple" id="index-2">
<li><strong>Allocation</strong> — how are state variables allocated?<ul>
<li>Minimize the number of independent global variables</li>
<li>Put them in easy-to-find places (no easter egg hunts)</li>
</ul>
</li>
</ul>
<ul class="simple" id="index-3">
<li><strong>Access</strong> — how are state variables accessed by functions?<ul>
<li>Functions (with limited exceptions, such as <code class="docutils literal notranslate"><span class="pre">main()</span></code>, ISRs and the HAL)
do not directly access global variables</li>
<li>Primitive types are passed in directly as arguments</li>
<li>Structures are passed in via a pointer or <code class="docutils literal notranslate"><span class="pre">const</span></code> pointer,
and the smallest applicable structure is used.</li>
</ul>
</li>
</ul>
<p>Our goal is to follow the principle of least knowledge in the
design of our system state; the top-level module functions get access to the
entire data structure, whereas lower-level functions get access to appropriate
pieces.</p>
<p>A simplified example may help explain this.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagMOTOR</span>
<span class="p">{</span>
  <span class="c1">// Current loop forward path</span>
  <span class="n">MC_DQ_T</span> <span class="n">vdqCmd</span><span class="p">;</span> <span class="c1">// desired dq-frame voltage, direct output of current loop</span>
  <span class="n">MC_DQ_T</span> <span class="n">vdq</span><span class="p">;</span> <span class="c1">// desired dq-frame voltage</span>
  <span class="n">MC_ALPHABETA_T</span> <span class="n">valphabeta</span><span class="p">;</span> <span class="c1">// desired alphabeta-frame voltage</span>
  <span class="n">MC_ABC_T</span> <span class="n">vabc</span><span class="p">;</span> <span class="c1">// desired phase voltage</span>
  <span class="n">MC_DUTYCYCLEOUT_T</span> <span class="n">pwmDutycycle</span><span class="p">;</span> <span class="c1">// PWM count</span>
  <span class="c1">// Angle and speed, including estimators</span>
  <span class="kt">int16_t</span> <span class="n">thetaElectrical</span><span class="p">;</span> <span class="c1">// electrical angle</span>
  <span class="kt">int16_t</span> <span class="n">omegaElectrical</span><span class="p">;</span> <span class="c1">// electrical frequency</span>
  <span class="n">MC_SINCOS_T</span> <span class="n">sincos</span><span class="p">;</span> <span class="c1">// sine and cosine of electrical angle</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">MCAF_MOTOR_DATA</span><span class="p">;</span>
</pre></div>
</div>
<p>The top-level module functions look like the following. Note that
the function <code class="docutils literal notranslate"><span class="pre">MCAF_FocStepIsr()</span></code> does have access
to the entire <code class="docutils literal notranslate"><span class="pre">MCAF_MOTOR_DATA</span></code> structure, but it calls other functions, such as
<code class="docutils literal notranslate"><span class="pre">MC_CalculateSineCosine_Assembly_Ram()</span></code> and <code class="docutils literal notranslate"><span class="pre">MC_TransformParkInverse_Assembly()</span></code>
which only have access to appropriate information within that structure.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">MCAF_FocStepIsr</span><span class="p">(</span><span class="n">MCAF_MOTOR_DATA</span> <span class="o">*</span><span class="n">pmotor</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="cm">/* Calculate Sine and Cosine from pmotor-&gt;theta_e */</span>
  <span class="n">MC_CalculateSineCosine_Assembly_Ram</span><span class="p">(</span><span class="n">pmotor</span><span class="o">-&gt;</span><span class="n">thetaElectrical</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmotor</span><span class="o">-&gt;</span><span class="n">sincos</span><span class="p">);</span>
  <span class="cm">/* Calculate vAlpha, Vbeta from Sine, Cosine, Vd and Vq */</span>
  <span class="n">MC_TransformParkInverse_Assembly</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmotor</span><span class="o">-&gt;</span><span class="n">vdq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmotor</span><span class="o">-&gt;</span><span class="n">sincos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmotor</span><span class="o">-&gt;</span><span class="n">valphabeta</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This frees many of the modules from having to <code class="docutils literal notranslate"><span class="pre">#include</span></code> the main system state
and reduces inter-module dependency. Changes in overall application behavior
do not generally affect individual module behavior, so recompilation and
testing are required less often.</p>
<p>Note that the module functions with this approach do not “own” their data.
They do not allocate any global variables, do not access any global
variables, and do not maintain any permanent pointers to external data.
Instead, data is passed in as an argument. The module functions will operate
on any data passed in. They don’t care whether they operate on data from one
motor or another, or whether it’s mock data from a testing program or real
data from an <a class="reference internal" href="../appendix/glossary.html#term-adc"><span class="xref std std-term">ADC</span></a>.</p>
<p>As a result, the module functions are easily covered by unit tests. We just
create sample inputs, call the appropriate function, and examine the outputs.</p>
<p>The main application is responsible for allocating program state variables for
the entire system, and for each motor.</p>
<p>One consequence of this philosophy is that many of the motor control parameters
cannot be hard-coded in the application; instead, they must be <a class="reference internal" href="config-params.html"><span class="doc">configurable parameters</span></a>.
The reason is that we wish to support control of two different
motors at once using the same module functions, and each motor may have
different software parameters, so these parameters need to be removed from the
code and kept in state variables.</p>
<div class="section" id="miscellaneous-guidelines">
<h2>3.3.1. Miscellaneous Guidelines<a class="headerlink" href="#miscellaneous-guidelines" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Related state variables belong together. If a group of variables are always
found and used together, they are probably best off if declared as members in
a structure.</p>
</li>
<li><p class="first">Hierarchy can assist and simplify naming: if there are 5 counters e.g.
<code class="docutils literal notranslate"><span class="pre">counterError</span></code>, <code class="docutils literal notranslate"><span class="pre">counterSuccess</span></code>, <code class="docutils literal notranslate"><span class="pre">counterResets</span></code>, <code class="docutils literal notranslate"><span class="pre">counterButtonPresses</span></code>,
and <code class="docutils literal notranslate"><span class="pre">counterOvercurrent</span></code>, these could be combined into a <code class="docutils literal notranslate"><span class="pre">counters</span></code>
structure with the members not needing the word <code class="docutils literal notranslate"><span class="pre">counter</span></code> because they are
now contained in a context that implies they are counters:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagCOUNTERS</span>
<span class="p">{</span>
  <span class="kt">uint16_t</span> <span class="n">error</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">success</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">resets</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">buttonPresses</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">overcurrent</span><span class="p">;</span>
<span class="p">}</span> <span class="n">COUNTER_DATA</span><span class="p">;</span>

<span class="n">COUNTER_DATA</span> <span class="n">counters</span><span class="p">;</span>
<span class="o">++</span><span class="n">counters</span><span class="p">.</span><span class="n">resets</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">Embedded structures (structures which contain other structures) indicate
ownership: the contained structure is owned by, and is an inherent part of,
the containing structure.</p>
</li>
<li><p class="first">Referenced structures (structures which contain a pointer to other structures)
indicate association and non-exclusivity: a contained pointer allows access to
other data.</p>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3.3. State management</a><ul>
<li><a class="reference internal" href="#miscellaneous-guidelines">3.3.1. Miscellaneous Guidelines</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="naming.html"
                        title="previous chapter">3.2. Naming Conventions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="codegen.html"
                        title="next chapter">3.4. Code Generation</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="codegen.html" title="3.4. Code Generation"
             >next</a> |</li>
        <li class="right" >
          <a href="naming.html" title="3.2. Naming Conventions"
             >previous</a> |</li>
    <li><img class="nav-logo"
             src="../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../index.html">MCAF R6 RC8 (docver 6.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="index.html" >3. Architecture</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-2020, Microchip Technology, Inc..
    </div>
  </body>
</html>