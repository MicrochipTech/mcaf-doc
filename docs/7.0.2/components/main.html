<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>4.1. Main Application &#8212; MCAF R7 RC37 documentation (docver 7.0.2)</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/microchip.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mcaf_doc.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/contrib/auto-render.min.js"></script>
    <script src="../_static/rendermath.js"></script>
    <script src="../_static/svgcrop.js"></script>
    <script src="../_static/mcaf-styling.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.2. ADC Calibration and Compensation" href="adc.html" />
    <link rel="prev" title="4. Components" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="adc.html" title="4.2. ADC Calibration and Compensation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="4. Components"
             accesskey="P">previous</a> |</li>
    <li><img class="nav-logo"
             src="../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../index.html">MCAF R7 RC37 (docver 7.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">4. </span>Components</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">4.1. </span>Main Application</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="main-application">
<span id="component-main"></span><h1><span class="section-number">4.1. </span>Main Application<a class="headerlink" href="#main-application" title="Permalink to this heading">¶</a></h1>
<p>As mentioned in the section on <a class="reference internal" href="../architecture/schedopt.html#scheduling"><span class="std std-ref">scheduling</span></a>, the main application
consists of a portion of code that executes in <code class="docutils literal notranslate"><span class="pre">main()</span></code>.</p>
<section id="implementation-notes">
<h2><span class="section-number">4.1.1. </span>Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permalink to this heading">¶</a></h2>
<section id="mcaf-r1-r5">
<h3><span class="section-number">4.1.1.1. </span>MCAF R1 – R5<a class="headerlink" href="#mcaf-r1-r5" title="Permalink to this heading">¶</a></h3>
<p>Prior to MCAF R6, the main application was tightly integrated with MCAF, while keeping
the responsibility for the user interface entirely within the <a class="reference internal" href="ext-interface.html#ext-interface"><span class="std std-ref">External Interface</span></a> component.</p>
</section>
<section id="mcaf-r6">
<span id="component-main-r6"></span><h3><span class="section-number">4.1.1.2. </span>MCAF R6<a class="headerlink" href="#mcaf-r6" title="Permalink to this heading">¶</a></h3>
<p>The main application has been rewritten to include a sample application. The sample application interacts
with MCAF through the <a class="reference internal" href="mcapi.html#mcapi"><span class="std std-ref">Motion Control API (MCAPI)</span></a> to control and obtain feedback from the motor.</p>
</section>
<section id="mcaf-r7">
<span id="component-main-r7"></span><h3><span class="section-number">4.1.1.3. </span>MCAF R7<a class="headerlink" href="#mcaf-r7" title="Permalink to this heading">¶</a></h3>
<p>The main application now utilizes the <a class="reference internal" href="mcapi.html#mcapi"><span class="std std-ref">Motion Control API</span></a> as the single point of interface
to MCAF, reducing exposure to MCAF internals.</p>
<blockquote>
<div><ul class="simple">
<li><p>Sample application can attempt to restart the motor while it is stopping</p></li>
<li><p>Added two new files: mcaf_main.c and mcaf_sample_application.h</p></li>
<li><dl class="simple">
<dt>Moved the definition of <code class="docutils literal notranslate"><span class="pre">MCAF_MOTOR_DATA</span> <span class="pre">motor</span></code> and <code class="docutils literal notranslate"><span class="pre">MCAF_SYSTEM_DATA</span> <span class="pre">systemData</span></code> from</dt><dd><p>sample_mcaf_application.c to mcaf_main.c</p>
</dd>
</dl>
</li>
<li><p>Updated the function signature of <code class="docutils literal notranslate"><span class="pre">APP_ApplicationInitialize()</span></code> and <code class="docutils literal notranslate"><span class="pre">APP_ApplicationStep()</span></code> to
include a pointer to the MCAPI data structure.</p></li>
<li><p>Moved <code class="docutils literal notranslate"><span class="pre">MCAF_Init()</span></code> and <code class="docutils literal notranslate"><span class="pre">MCAF_MainLoop()</span></code> to mcaf_main.c</p></li>
</ul>
</div></blockquote>
<section id="sample-application">
<span id="id1"></span><h4><span class="section-number">4.1.1.3.1. </span>Sample Application<a class="headerlink" href="#sample-application" title="Permalink to this heading">¶</a></h4>
<p>The sample application user interface behavior can be summarized as follows:</p>
<blockquote>
<div><ul>
<li><p>If the motor is stopping/stopped, then the primary pushbutton starts the motor.
If the primary pushbutton is pressed during the <code class="docutils literal notranslate"><span class="pre">STOPPING</span></code> state, the
<a class="reference internal" href="statemach.html#component-statemachine"><span class="std std-ref">state machine</span></a> will behave differently depending on
the <a class="reference internal" href="../algorithms/stopping.html#algorithm-stopping"><span class="std std-ref">stopping mode</span></a>:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../algorithms/stopping.html#algorithm-stopping-min-impact"><span class="std std-ref">Minimal-impact PWM</span></a> state transition
sequence: <code class="docutils literal notranslate"><span class="pre">STOPPING</span></code>, <code class="docutils literal notranslate"><span class="pre">STOPPED</span></code>, <code class="docutils literal notranslate"><span class="pre">STARTING</span></code>, <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code></p></li>
<li><p><a class="reference internal" href="../algorithms/stopping.html#algorithm-stopping-closed-loop"><span class="std std-ref">Closed-loop (current or velocity)</span></a> state
transition sequence: <code class="docutils literal notranslate"><span class="pre">STOPPING</span></code>, <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code></p></li>
</ul>
</div></blockquote>
</li>
<li><p>If the motor is starting/running, then the primary pushbutton stops the motor.</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>If the motor is in fault condition, then the primary pushbutton clears all pending faults.</p></li>
<li><p>If MCAF is in one of its test modes, then the primary pushbutton and the secondary pushbutton do
not have any effect.</p></li>
<li><p>The secondary pushbutton changes the direction of rotation.</p></li>
<li><p>The potentiometer sets the speed reference for the motor, with minimum and maximum limits as defined
by MCAF and made available through MCAPI functions <code class="docutils literal notranslate"><span class="pre">MCAPI_VelocityReferenceMinimumGet()</span></code> and
<code class="docutils literal notranslate"><span class="pre">MCAPI_VelocityReferenceMaximumGet()</span></code> respectively.</p></li>
<li><p>The pushbutton and potentiometer user interface can be disabled in the sample application by
clearing <code class="docutils literal notranslate"><span class="pre">hardwareUiEnabled</span></code> in the application data structure, for instance using a
real-time diagnostic tool like <a class="reference external" href="https://gallery.microchip.com/packages/x2c-scope/">X2C-Scope</a>.</p></li>
</ul>
<p>See <a class="reference internal" href="ext-interface.html#ext-interface"><span class="std std-ref">External Interface</span></a> for implementation details of the user interface for pushbuttons.</p>
<p>The user interface for LEDs is defined and implemented by the <a class="reference internal" href="ext-interface.html#ext-interface"><span class="std std-ref">External Interface</span></a> component.</p>
</section>
</section>
<section id="modules">
<h3><span class="section-number">4.1.1.4. </span>Modules<a class="headerlink" href="#modules" title="Permalink to this heading">¶</a></h3>
<span id="index-0"></span><table class="components-table docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Module</p></th>
<th class="head"><p>Files</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Comments</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">isr</span></code></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">isr.c</span></code></div>
</div>
</td>
<td><p>Top-level ISR</p></td>
<td><p>The main control <a class="reference internal" href="../appendix/glossary.html#term-ISR"><span class="xref std std-term">ISR</span></a> function runs on a periodic basis.
It is triggered at the completion of <a class="reference internal" href="../appendix/glossary.html#term-ADC"><span class="xref std std-term">ADC</span></a> sampling,
which in turn is triggered once per <a class="reference internal" href="../appendix/glossary.html#term-PWM"><span class="xref std std-term">PWM</span></a> cycle, as mentioned in the
<a class="reference internal" href="../architecture/schedopt.html#scheduling"><span class="std std-ref">Scheduling</span></a> section. It contains profiling logic:</p>
<ul class="simple">
<li><p>generates a pulse on a GPIO pin that starts on <a class="reference internal" href="../appendix/glossary.html#term-ISR"><span class="xref std std-term">ISR</span></a> entry and ends on <a class="reference internal" href="../appendix/glossary.html#term-ISR"><span class="xref std std-term">ISR</span></a> exit</p></li>
<li><p>capture of timer counter (see <a class="reference internal" href="testharness.html#test-timestamps"><span class="std std-ref">test harness</span></a>)</p></li>
</ul>
<p>Various <a class="reference internal" href="../appendix/glossary.html#term-ISR"><span class="xref std std-term">ISR</span></a> subtasks are executed in rough order of priority (state machine tasks
first, test harness and diagnostic tasks last).</p>
<p>The actual name of the <a class="reference internal" href="../appendix/glossary.html#term-ADC"><span class="xref std std-term">ADC</span></a> <a class="reference internal" href="../appendix/glossary.html#term-ISR"><span class="xref std std-term">ISR</span></a> function is hardware-dependent and is encapsulated
in the <a class="reference internal" href="hal.html#hal"><span class="std std-ref">HAL</span></a> by the <code class="docutils literal notranslate"><span class="pre">HAL_ADC_ISR</span></code> macro.</p>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">mcaf_main</span></code></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">mcaf_main.c</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">mcaf_main.h</span></code></div>
</div>
</td>
<td><p>Main MCAF entry points called from <code class="docutils literal notranslate"><span class="pre">main()</span></code> (initialization and main loop)</p></td>
<td><p>Provides <code class="docutils literal notranslate"><span class="pre">MCAF_MainInit()</span></code> and <code class="docutils literal notranslate"><span class="pre">MCAF_MainLoop()</span></code>. These are the
entry points for MCAF from the <code class="docutils literal notranslate"><span class="pre">main()</span></code>.</p></td>
</tr>
<tr class="row-even"><td class="longcolumn-3"><code class="docutils literal notranslate"><span class="pre">mcaf_sample_application</span></code></td>
<td class="longcolumn-3"><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">mcaf_sample_application.c</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">mcaf_sample_application.h</span></code></div>
</div>
</td>
<td><p>Sample application</p></td>
<td><p>Sample application starts/stops the motor using pushbuttons
and sets motor speed reference using the potentiometer.</p></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">mcaf_traps</span></code></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">mcaf_traps.c</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">mcaf_traps.h</span></code></div>
</div>
</td>
<td><p>Trap interrupt handlers</p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">system_init</span></code></td>
<td class="longcolumn-1"><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">system_init.c</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">system_init.h</span></code></div>
</div>
</td>
<td><p>System initialization</p></td>
<td><p>Initializes state variables and special function registers prior to the main loop
(intended to be called in <code class="docutils literal notranslate"><span class="pre">MCAF_MainInit()</span></code>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MCAF_SystemInit</span></code> — called at the beginning of <code class="docutils literal notranslate"><span class="pre">MCAF_MainInit()</span></code> to initialize
certain SFRs and system-wide state variables as soon as possible.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MCAF_SystemStart</span></code> — called near the end of <code class="docutils literal notranslate"><span class="pre">MCAF_MainInit()</span></code>
for deferred initialization. This includes code to enable interrupts, and therefore
main-thread code that executes prior to <code class="docutils literal notranslate"><span class="pre">MCAF_SystemStart</span></code> is not prone to race conditions
caused by conflicts with an <a class="reference internal" href="../appendix/glossary.html#term-ISR"><span class="xref std std-term">ISR</span></a> that has just been enabled.</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">system_state</span></code></td>
<td class="longcolumn-1"><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">system_state.c</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">system_state.h</span></code></div>
</div>
</td>
<td><p>System state variable type definitions</p></td>
<td><p>Defines the main <code class="docutils literal notranslate"><span class="pre">MCAF_MOTOR_DATA</span></code> and <code class="docutils literal notranslate"><span class="pre">MCAF_SYSTEM_DATA</span></code> structure types.</p></td>
</tr>
</tbody>
</table>
<section id="trap-handler-module">
<span id="main-traps"></span><h4><span class="section-number">4.1.1.4.1. </span>Trap-handler module<a class="headerlink" href="#trap-handler-module" title="Permalink to this heading">¶</a></h4>
<p>Hardware trap vectors in dsPIC<sup>®</sup> DSC devices contain handlers for events like
a stack overflow, or an address alignment error. In the MCAF, these are located
in the <code class="docutils literal notranslate"><span class="pre">traps</span></code> module. The normal handling logic is to signal a nonrecoverable
error, by calling the <code class="docutils literal notranslate"><span class="pre">halt_on_error()</span></code>
function, which records an error code and goes into an endless loop to
flash the LEDs to indicate an error code via <code class="docutils literal notranslate"><span class="pre">MCAF_UiFlashErrorCodeForever()</span></code>
as discussed in the UI module.</p>
<p>Two minor deviations from this behavior:</p>
<ul class="simple">
<li><p><strong>DMA write collision</strong>: this occurs when the CPU and a DMA channel write to the
same address (in which case the CPU “wins” and the DMA write is ignored). This
condition is not considered an error in this application, and arises in rare cases
for one variant of the diagnostic module which utilizes the DMA for reading and
writing the UART. The DMA trap handler increments a counter for assessing the
frequency of DMA write collisions.</p></li>
<li><p><strong>Stack overflow</strong>: a stack overflow is a nonrecoverable error, but is slightly
different in that the stack pointer (W15 on dsPIC<sup>®</sup> DSC devices) may not be valid.
In this condition, the MCAF takes extra care by using a small “failsafe stack”,
which is a static area of
memory reserved for this case, and is large enough to cover the stack requirements
needed by the <code class="docutils literal notranslate"><span class="pre">MCAF_UiFlashErrorCodeForever()</span></code> function.</p></li>
</ul>
<p>In addition to hardware traps, the <code class="docutils literal notranslate"><span class="pre">traps</span></code> module also includes logic to
examine cause of reset, so that in the event of a watchdog reset, a nonrecoverable
error can be signaled via <code class="docutils literal notranslate"><span class="pre">MCAF_UiFlashErrorCodeForever()</span></code>.</p>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">4.1. Main Application</a><ul>
<li><a class="reference internal" href="#implementation-notes">4.1.1. Implementation Notes</a><ul>
<li><a class="reference internal" href="#mcaf-r1-r5">4.1.1.1. MCAF R1 – R5</a></li>
<li><a class="reference internal" href="#mcaf-r6">4.1.1.2. MCAF R6</a></li>
<li><a class="reference internal" href="#mcaf-r7">4.1.1.3. MCAF R7</a><ul>
<li><a class="reference internal" href="#sample-application">4.1.1.3.1. Sample Application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#modules">4.1.1.4. Modules</a><ul>
<li><a class="reference internal" href="#trap-handler-module">4.1.1.4.1. Trap-handler module</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="index.html"
                          title="previous chapter"><span class="section-number">4. </span>Components</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="adc.html"
                          title="next chapter"><span class="section-number">4.2. </span>ADC Calibration and Compensation</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="adc.html" title="4.2. ADC Calibration and Compensation"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="4. Components"
             >previous</a> |</li>
    <li><img class="nav-logo"
             src="../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../index.html">MCAF R7 RC37 (docver 7.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">4. </span>Components</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">4.1. </span>Main Application</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-2023, Microchip Technology, Inc..
    </div>
  </body>
</html>