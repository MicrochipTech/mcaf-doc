<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>4.3. State Machine &#8212; MCAF R7 RC37 documentation (docver 7.0.2)</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/microchip.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mcaf_doc.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/contrib/auto-render.min.js"></script>
    <script src="../_static/rendermath.js"></script>
    <script src="../_static/svgcrop.js"></script>
    <script src="../_static/mcaf-styling.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.4. Field-Oriented Control (FOC)" href="foc.html" />
    <link rel="prev" title="4.2. ADC Calibration and Compensation" href="adc.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="foc.html" title="4.4. Field-Oriented Control (FOC)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="adc.html" title="4.2. ADC Calibration and Compensation"
             accesskey="P">previous</a> |</li>
    <li><img class="nav-logo"
             src="../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../index.html">MCAF R7 RC37 (docver 7.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">4. </span>Components</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">4.3. </span>State Machine</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="state-machine">
<span id="component-statemachine"></span><h1><span class="section-number">4.3. </span>State Machine<a class="headerlink" href="#state-machine" title="Permalink to this heading">¶</a></h1>
<p>The motor control state machine can be described as a hierarchical state
machine, shown below in <a class="reference internal" href="#fig-state-machine"><span class="std std-numref">Figure 4.1</span></a>.
The states are shown in blue; the names (<code class="docutils literal notranslate"><span class="pre">MCSM_xxxx</span></code>) are
the ones used in the application framework code. Transition conditions are shown
as labeled arrows.</p>
<p>This state machine is intended to treat the motor controller at a very high
level: rather than concern itself with detailed information about the motor (is
a stall occurring? is there an overvoltage?), the state machine is designed
around general events like whether a fault has been detected, or whether a start
or stop sequence is complete.</p>
<figure class="align-center" id="id2">
<span id="fig-state-machine"></span><img alt="../_images/state-machine.svg" src="../_images/state-machine.svg" /><figcaption>
<p><span class="caption-number">Figure 4.1 </span><span class="caption-text">Motor controller state diagram</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<section id="states">
<span id="component-statemachine-states"></span><h2><span class="section-number">4.3.1. </span>States<a class="headerlink" href="#states" title="Permalink to this heading">¶</a></h2>
<p>These states are divided into subgroups:</p>
<ul class="simple">
<li><p>Primary states: all the states except for those used in test operation.</p>
<ul>
<li><p>Normal states: states where a fault is not occurring.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MCSM_FAULT</span></code>: a fault has occurred.</p></li>
</ul>
</li>
<li><p>Secondary states: all the states used in test operation. These states cause
the normal state machine to be ignored, along with some of the fault detection
algorithms that may produce false positives when in test modes.</p></li>
</ul>
<p>The grouping here forms a hierarchical state machine. For example: any of the
normal states will transition to <code class="docutils literal notranslate"><span class="pre">MCSM_FAULT</span></code> if a fault has been detected.
(Traditional state machines would require transitions to <code class="docutils literal notranslate"><span class="pre">MCSM_FAULT</span></code> to be shown
from <code class="docutils literal notranslate"><span class="pre">MCSM_STOPPED</span></code>, <code class="docutils literal notranslate"><span class="pre">MCSM_STARTING</span></code>, <code class="docutils literal notranslate"><span class="pre">MCSM_RUNNING</span></code>, <code class="docutils literal notranslate"><span class="pre">MCSM_STOPPING</span></code>,
and <code class="docutils literal notranslate"><span class="pre">MCSM_INIT</span></code>.)</p>
<p>The initial state after power-on reset is <code class="docutils literal notranslate"><span class="pre">MCSM_RESTART</span></code>. The states are described briefly below:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>State</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Assumptions</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">MCSM_RESTART</span></code></p></td>
<td><p>Initial state, entered whenever we power up,
or we exit the fault state or a test mode
and there is no fault present.</p>
<p>Certain run-time calibration activities may
be performed.</p>
</td>
<td><p>It is acceptable to let the motor current
stay at zero.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">MCSM_STOPPING</span></code></p></td>
<td><p>The motor controller attempts to bring the
motor to a complete stop.</p></td>
<td><p>The motor may be rotating.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">MCSM_STOPPED</span></code></p></td>
<td><p>The motor controller has brought the motor
to a complete stop.</p></td>
<td><p>The motor is not rotating.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">MCSM_STARTING</span></code></p></td>
<td><p>The motor controller attempts to rotate the motor
from rest. This may require specialized code, for
example in a controller with a sensorless
estimator, or in a compressor.</p></td>
<td><p>The motor velocity may be zero or small.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">MCSM_RUNNING</span></code></p></td>
<td><p>The motor controller attempts to control the
motor to a specified control goal, typically
regulation of motor velocity.</p></td>
<td><p>Control of the motor has been successful
so far.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">MCSM_FAULT</span></code></p></td>
<td><p>The motor controller has recognized a fault
condition, under which it is unable to proceed
safely with normal control activities.</p>
<p>The motor controller’s actuators are brought to
a <a class="reference internal" href="hal.html#hardware-pwm"><span class="std std-ref">“minimal impact”</span></a>
state which is deemed
acceptable under fault conditions: typically
the upper transistors are off, and lower
transistors are either off,
or set at a small duty cycle.</p>
<p>This is a “latched” state: on entry, latch an
error code describing the fault, and display
this code until external intervention occurs
from a <code class="docutils literal notranslate"><span class="pre">CLEAR_FAULT</span></code> condition.</p>
</td>
<td><p>In general, none. The motor may be rotating
or not. The motor may be damaged,
the transistors may be damaged, voltages and
currents may be out of range, etc.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">MCSM_TEST_DISABLE</span></code></p></td>
<td><p>Test state, with transistors set to a minimal
impact state.</p>
<p>User interface inputs are generally ignored
in favor of inputs from diagnostic equipment.</p>
</td>
<td><p>Either a fault has been detected during a
test mode, or the controller is intentionally
disabled.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">MCSM_TEST_ENABLE</span></code></p></td>
<td><p>Test state, with transistors enabled. Control
goal is set by a test operating mode, and is
usually different from normal running conditions.</p>
<p>For example: one or more control loops disabled,
certain fault detections disabled, etc.</p>
<p>User interface inputs are generally ignored
in favor of inputs from diagnostic equipment.</p>
</td>
<td><p>The motor controller is being operated in a
nonstandard test mode, under controlled
conditions, by someone who knows what
they are doing.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="input-conditions">
<h2><span class="section-number">4.3.2. </span>Input conditions<a class="headerlink" href="#input-conditions" title="Permalink to this heading">¶</a></h2>
<p>The high-level input conditions, shown in the state diagram of <a class="reference internal" href="#fig-state-machine"><span class="std std-numref">Figure 4.1</span></a>, are
used in a mutually exclusive manner (in other words, all conditions starting
from a given state are mutually exclusive), and can be defined from more basic
conditions as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FAULT</span></code>: Both of the following are true:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">operating_fault_detected</span></code> is true (see next section)</p></li>
<li><p>operating mode is <code class="docutils literal notranslate"><span class="pre">OM_NORMAL</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">CLEAR_FAULT</span></code>:</p>
<ul>
<li><p>UI module indicates an intention to clear the latched fault.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">RESTART_COMPLETE</span></code>: OK for the controller to leave the <code class="docutils literal notranslate"><span class="pre">RESTART</span></code> state. True if all of the following are true:</p>
<ul>
<li><p>operating mode is <code class="docutils literal notranslate"><span class="pre">OM_NORMAL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">operating_fault_detected</span></code> is not true</p></li>
<li><p>initialization activities for the <code class="docutils literal notranslate"><span class="pre">RESTART</span></code> state are complete</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">AT_REST</span></code>: OK for the controller to leave the <code class="docutils literal notranslate"><span class="pre">RESTART</span></code> state into the <code class="docutils literal notranslate"><span class="pre">STOPPED</span></code> state.
True if all of the folowing are true:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">RESTART_COMPLETE</span></code> is true</p></li>
<li><p><a class="reference internal" href="../algorithms/stopping.html#algorithm-stopping"><span class="std std-ref">stopping mode</span></a> is closed-loop</p></li>
<li><p>a startup completion flag has not yet been set by the startup routine.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">READY</span></code>: OK for the controller to leave the <code class="docutils literal notranslate"><span class="pre">RESTART</span></code> state into the <code class="docutils literal notranslate"><span class="pre">STOPPING</span></code> state.
True if all of the following are true:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">RESTART_COMPLETE</span></code> is true</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AT_REST</span></code> is not true</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">RESUME</span></code>: OK for the controller to move from the <code class="docutils literal notranslate"><span class="pre">STOPPING</span></code> state into the <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code> state. True if all of the following are true:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">RUN</span></code> is true</p></li>
<li><p><a class="reference internal" href="../algorithms/stopping.html#algorithm-stopping"><span class="std std-ref">stopping mode</span></a> is closed-loop</p></li>
<li><p>a startup completion flag has been set by the startup routine.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">RUN</span></code>: the motor will run. True if all of the following are true:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">run_requested</span></code>: UI module indicates an intention for the motor to run.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_permitted</span></code>: motor is permitted to run; false if a stall condition has been detected.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">operating_fault_detected</span></code> is not true.</p></li>
<li><p>operating mode is <code class="docutils literal notranslate"><span class="pre">OM_NORMAL</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">START_COMPLETE</span></code>: True if all of the following are true:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">RUN</span></code> is true</p></li>
<li><p>a startup completion flag has been set by the startup routine.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">STOP_COMPLETE</span></code>: True if all of the following are true:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">RESUME</span></code> is not true</p></li>
<li><p>a stop completion flag has been set by the <a class="reference internal" href="../algorithms/stopping.html#algorithm-stopping"><span class="std std-ref">stopping routine</span></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">operating_fault_detected</span></code> is not true</p></li>
<li><p>operating mode is <code class="docutils literal notranslate"><span class="pre">OM_NORMAL</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">TEST_DISABLE</span></code>: True if either of the following are true:</p>
<ul>
<li><p>operating mode is <code class="docutils literal notranslate"><span class="pre">OM_DISABLED</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test_fault_detected</span></code> is true</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">TEST_ENABLE</span></code>: True if all of the following are true:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">test_fault_detected</span></code> is not true</p></li>
<li><p>operating mode is any other mode aside from <code class="docutils literal notranslate"><span class="pre">OM_DISABLED</span></code> or <code class="docutils literal notranslate"><span class="pre">OM_NORMAL</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">TEST_EXIT</span></code>: True if the operating mode is <code class="docutils literal notranslate"><span class="pre">OM_NORMAL</span></code>, and <code class="docutils literal notranslate"><span class="pre">FAULT</span></code> is not true</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TEST_EXIT_FAULT</span></code>: True if the operating mode is <code class="docutils literal notranslate"><span class="pre">OM_NORMAL</span></code>, and <code class="docutils literal notranslate"><span class="pre">FAULT</span></code> is true</p></li>
</ul>
<p>In some ways it may be easier to think about a prioritized implementation of
state transitions, which would probably look like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">operating_mode</span> <span class="o">!=</span> <span class="n">OM_NORMAL</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">OM_DISABLED</span> <span class="o">||</span> <span class="n">test_fault_detected</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_TEST_DISABLE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_TEST_ENABLE</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* primary states begin here... */</span>
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">operating_fault_detected</span> <span class="o">&amp;&amp;</span> <span class="n">this_state</span> <span class="o">!=</span> <span class="n">MCSM_FAULT</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_FAULT</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
  <span class="cm">/* normal states */</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="nl">MCSM_TEST_DISABLE</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">MCSM_TEST_ENABLE</span><span class="p">:</span>
      <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_RESTART</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">MCSM_RESTART</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ready</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_STOPPING</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">MCSM_STOPPING</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">stop_complete</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_STOPPED</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">MCSM_STOPPED</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">run</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_STARTING</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">MCSM_STARTING</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">run</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_STOPPING</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">start_complete</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_RUNNING</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">MCSM_RUNNING</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">run</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_STOPPING</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">MCSM_FAULT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">clear_fault_latch</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_RESTART</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">next_state</span> <span class="o">=</span> <span class="n">MCSM_RESTART</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="miscellaneous-state-machine-issues">
<h2><span class="section-number">4.3.3. </span>Miscellaneous state machine issues<a class="headerlink" href="#miscellaneous-state-machine-issues" title="Permalink to this heading">¶</a></h2>
<section id="startup">
<span id="motor-startup"></span><h3><span class="section-number">4.3.3.1. </span>Startup<a class="headerlink" href="#startup" title="Permalink to this heading">¶</a></h3>
<p>While in the <code class="docutils literal notranslate"><span class="pre">MCSM_STARTING</span></code> state, a specialized startup process
is used to bring the motor from rest to a sufficient speed
for the <a class="reference internal" href="foc.html#posvelest"><span class="std std-ref">sensorless estimator</span></a> to provide commutation information.
During this state, the velocity loop is disabled, and commutation angle is
slowly accelerated in an open-loop fashion, instead of using the commutation
angle from the sensorless estimator.</p>
<p>See the section on <a class="reference internal" href="../algorithms/startup.html#algorithm-startup"><span class="std std-ref">startup</span></a> for
more information.</p>
</section>
<section id="fault-detection">
<h3><span class="section-number">4.3.3.2. </span>Fault detection<a class="headerlink" href="#fault-detection" title="Permalink to this heading">¶</a></h3>
<p>Fault detection behaves slightly differently, depending on whether the system
is in a test state or a normal mode of operation.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">test_fault_detected</span></code>: In test states, we want to be more lenient in allowing
requested operations, so this flag is true only when any of the most severe
faults are true; these include things like hardware overcurrent, software
overcurrent, overvoltage, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">operating_fault_detected</span></code>: In normal operating modes, we want to be more
conservative, and stop operation under a wider set of conditions. This
includes all of the faults used in <code class="docutils literal notranslate"><span class="pre">test_fault_detected</span></code>, along with other
faults not included in <code class="docutils literal notranslate"><span class="pre">test_fault_detected</span></code>, such as stall retry count exceeded.</p>
<p>This allows detection techniques to be used in normal operating modes, but
remain disabled in test modes, so that they do not interfere with tests
that might otherwise trigger a fault. Certain heuristic detection techniques
belong here, especially if they make assumptions about how the motor is operating
(e.g. always in velocity control mode, always rotating in one direction,
smoothly-changing velocity commands, etc.) or there is some uncertainty
about whether the detection technique can avoid false positives.</p>
</li>
</ul>
<p>Both fault detection schemes are latched, requiring outside action to
clear them (for example, a UI button press for the primary states,
diagnostic tool action for the test states).</p>
</section>
</section>
<section id="implementation-notes">
<span id="component-statemachine-impl"></span><h2><span class="section-number">4.3.4. </span>Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permalink to this heading">¶</a></h2>
<p>The function <code class="docutils literal notranslate"><span class="pre">MCAF_SystemStateMachine_StepIsr()</span></code> is the main entry point for
the system state machine. The approach used in this function is to execute
these subtasks:</p>
<ul class="simple">
<li><p>First execute critical tasks common to all states — <code class="docutils literal notranslate"><span class="pre">MCAF_MotorControllerOnAllStates()</span></code></p></li>
<li><p>Determine next state — <code class="docutils literal notranslate"><span class="pre">MCAF_FSM_DetermineNextState()</span></code> and <code class="docutils literal notranslate"><span class="pre">MCAF_FSM_DetermineNextStateTestMode()</span></code></p></li>
<li><p>Dispatch to the appropriate state — <code class="docutils literal notranslate"><span class="pre">MCAF_FSM_Dispatch()</span></code></p></li>
<li><p>Finally execute noncritical tasks common to all states — <code class="docutils literal notranslate"><span class="pre">MCAF_MotorControllerOnAllStatesLowPriority()</span></code></p></li>
</ul>
<p>Field-oriented control tasks are executed in</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MCAF_FocStepIsrFeedbackPath()</span></code> — This function is executed in all states
and includes feedback calculations such as Park/Clarke transforms and
position/velocity estimation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MCAF_FocStepIsrForwardPath()</span></code> — This function is executed in states
when motor control is active, and includes both the controllers and
other forward path elements such as the inverse Park/Clarke transforms
and space vector modulation.</p></li>
</ul>
<p>The function <code class="docutils literal notranslate"><span class="pre">MCAF_SystemStateMachine_StepMain()</span></code> executes low-priority
tasks for the system state machine. At this time, the only such task
is selecting LED patterns for the <a class="reference internal" href="ext-interface.html#ext-interface-leds"><span class="std std-ref">external interface</span></a>
to indicate motor direction and state machine state.</p>
<section id="implementation-notes-for-stall-detection-and-recovery">
<h3><span class="section-number">4.3.4.1. </span>Implementation notes for stall detection and recovery:<a class="headerlink" href="#implementation-notes-for-stall-detection-and-recovery" title="Permalink to this heading">¶</a></h3>
<p>A detection of stall would cause the <code class="docutils literal notranslate"><span class="pre">run_permitted</span></code> flag to be false, and
therefore bring the motor from the <code class="docutils literal notranslate"><span class="pre">STARTING</span></code> or <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code> states into
the <code class="docutils literal notranslate"><span class="pre">STOPPING</span></code> state. It would not change the <code class="docutils literal notranslate"><span class="pre">run_requested</span></code> flag from the UI.</p>
<p>Stall detection / recovery need to keep track of a retry count, just as in
the existing implementation; when the retry count exceeded a threshold, the
“stall retry count exceeded” fault would be produced, and the <code class="docutils literal notranslate"><span class="pre">FAULT</span></code> state
entered.</p>
</section>
<section id="other-implementation-notes">
<h3><span class="section-number">4.3.4.2. </span>Other implementation notes<a class="headerlink" href="#other-implementation-notes" title="Permalink to this heading">¶</a></h3>
<p>State machine functions in each state, and for transitions, should not be called
except from the main state machine update function <code class="docutils literal notranslate"><span class="pre">MCAF_FSM_Dispatch()</span></code>.
The approach used in the MCAF
is to bring each of these functions out as inline functions, for code modularity and
maintainability, but not run-time modularity (treat it as one large function at
runtime).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">STOPPING</span></code> → <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code> transition was added in MCAF R7,
along with <a class="reference internal" href="../algorithms/stopping.html#algorithm-stopping-closed-loop"><span class="std std-ref">closed-loop stopping</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">RESTART</span></code> → <code class="docutils literal notranslate"><span class="pre">STOPPED</span></code> transition was added in MCAF R7,
along with the <code class="docutils literal notranslate"><span class="pre">AT_REST</span></code> condition. <strong>Note:</strong> the exact conditions
at which <code class="docutils literal notranslate"><span class="pre">AT_REST</span></code> is valid are still under investigation,
and are likely to change in a future version of MCAF.</p>
</section>
<section id="modules">
<h3><span class="section-number">4.3.4.3. </span>Modules<a class="headerlink" href="#modules" title="Permalink to this heading">¶</a></h3>
<span id="index-0"></span><table class="components-table docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Module</p></th>
<th class="head"><p>Files</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Comments</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">startup</span></code></td>
<td class="longcolumn-3"><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">parameters/startup_params.h</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">startup.c</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">startup.h</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">startup_types.h</span></code></div>
</div>
</td>
<td><p>Motor startup including the transition from open-loop commutation to closed-loop commutation</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">startup_lib</span></code></td>
<td class="longcolumn-1"><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">startup_lib.h</span></code></div>
</div>
</td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td class="longcolumn-1"><code class="docutils literal notranslate"><span class="pre">state_machine</span></code></td>
<td class="longcolumn-3"><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">state_machine.c</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">state_machine.h</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">state_machine_types.h</span></code></div>
</div>
</td>
<td><p>Top-level state machine</p></td>
<td><p></p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">4.3. State Machine</a><ul>
<li><a class="reference internal" href="#states">4.3.1. States</a></li>
<li><a class="reference internal" href="#input-conditions">4.3.2. Input conditions</a></li>
<li><a class="reference internal" href="#miscellaneous-state-machine-issues">4.3.3. Miscellaneous state machine issues</a><ul>
<li><a class="reference internal" href="#startup">4.3.3.1. Startup</a></li>
<li><a class="reference internal" href="#fault-detection">4.3.3.2. Fault detection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-notes">4.3.4. Implementation Notes</a><ul>
<li><a class="reference internal" href="#implementation-notes-for-stall-detection-and-recovery">4.3.4.1. Implementation notes for stall detection and recovery:</a></li>
<li><a class="reference internal" href="#other-implementation-notes">4.3.4.2. Other implementation notes</a></li>
<li><a class="reference internal" href="#modules">4.3.4.3. Modules</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="adc.html"
                          title="previous chapter"><span class="section-number">4.2. </span>ADC Calibration and Compensation</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="foc.html"
                          title="next chapter"><span class="section-number">4.4. </span>Field-Oriented Control (FOC)</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="foc.html" title="4.4. Field-Oriented Control (FOC)"
             >next</a> |</li>
        <li class="right" >
          <a href="adc.html" title="4.2. ADC Calibration and Compensation"
             >previous</a> |</li>
    <li><img class="nav-logo"
             src="../_static/Microchip-Logo-Horizontal-White-Red-120x28.png" alt=""
        /></li>
    <li><a href=""></a> &#187;</li>
    <a href="../index.html">MCAF R7 RC37 (docver 7.0.2)</a> &#187;
    
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">4. </span>Components</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">4.3. </span>State Machine</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-2023, Microchip Technology, Inc..
    </div>
  </body>
</html>